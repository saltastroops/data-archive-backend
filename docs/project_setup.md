# SALT/SAAO Data Archive API Server Setup

## Creating the project and adding dependencies

Create the project directory

```sh
mkdir backend
```

Navigate to the root directory of the project and initialise the code as an npm package.
To do that, execute the following commands and answer all the quetion asked.

```sh
cd backend
yarn init
```

Intall these required external packages by executing the following commands

```
yarn add typescript ts-node @types/graphql
```

Create the file named ```tsconfig.json``` which contains all the TypeScripts compiler options.
Make sure to enable the following compiler options (you can enable more acoording to the project setup).

```json
{
  "compilerOptions": {
    /* Basic Options */
    "target": "es5",                          /* Specify ECMAScript target version: 'ES3' (default), 'ES5', 'ES2015', 'ES2016', 'ES2017','ES2018' or 'ESNEXT'. */
    "module": "commonjs",                     /* Specify module code generation: 'none', 'commonjs', 'amd', 'system', 'umd', 'es2015', or 'ESNext'. */
    "lib": [
      "es2015", 
      "esnext.asynciterable"
    ],
    "noEmitOnError": true,                    /* Enable do not emit outputs if any errors were reported. */
    ...
  }       
}
```

Create a file named ```index.ts``` in the ```src``` directory.

```sh
touch src/index.ts
```

## Making it prettier

As proper code formatting and linting tends to be a good idea, let us add [Prettier](https://prettier.io/) and [TSLint](https://palantir.github.io/tslint/).

Execute the following command.

```
yarn add prettier tslint tslint-config-prettier --dev
```

The tslint-config-prettier package helps to ensure that Prettier and TSLint play along nicely.

We need some configuration for TSLint. Add a file ```tslint.json``` in the root directory,

```sh
touch tslint.json
```

and add the following content.

```json
{
    "extends": ["tslint:latest", "tslint-config-prettier"],
    "linterOptions": {
        "exclude": ["src/generated/**/*"]
    },
    "rules": {
        "member-access": {
            "severity": "off"
        }
    }
}
```

Refer to [TSLint’s documentation](https://palantir.github.io/tslint/rules/) for more detailed rules.

We should exclude the files automatically generated by Prisma from any
formatting. This is achieved by creating a file ```.prettierignore```  in the project root directory.

```sh
tousch .prettierignore
```

add a list of files and directories paths in the file you don't want to be affected by prettier.

Refer to [Prettier’s documentation](https://prettier.io/docs/en/configuration.html) for more Prettier configuration options.

In order to make sure that commited files are formated properly, a [Husky](https://github.com/typicode/husky) package is added along with the lint-stage. Before adding Husky, you must make sure that the git repository is initailed.

```
git init # if not done already
yarn add husky lint-staged --dev
```

Add Husky and lint-staged related configuration details to the package.json file.

```json
 ...
 "husky": {
    "hooks": {
        "pre-commit": "lint-staged"
    }
    },
 "lint-staged": {
    "src/**/*.{js,ts,tsx,json,css,graphql,md}": [
        "prettier --write",
        "git add"
    ]
 },
 ...
}
```

Now Prettier should be called on the committed files whenever you make a commit. 

# Creating a GraphQL server

GraphQL-Yoga is used to create the GraphQL API.

## Installing GraphQL-Yoga server.

```
yarn add graphql-yoga
```

Create a GraphQL schema file to define the shemas,

```sh
touch src/schema.graphql
```

and add the following content.

```graphql
type Query {
  user(id: ID!): User
  users(limit: Int): [User]!
}

type Mutation {
  addUser(name: String!): User!
}

type User {
  name: String!
}
```

Also add the folder for ```src/resolvers``` and the resolvers in it.

```sh
mkdir src/resolvers
cd src/resolvers
touch index.ts Mutation.ts Query.ts
```

Add the following content in the files respectively

```typescript
// src/resolvers/index.ts
import { Mutation } from "./Mutation";
import { Query } from "./Query";

// Defining resolvers
const resolvers = {
  Mutation,
  Query
};

export default resolvers;

// src/resolvers/Mutation.ts

// Defining  Mutation methods
const Mutation = {
  // Mutation for creating the user
  async addUser(root: any, args: any, ctx:  any) {
    // Code to add a user in the database
  }
};

export { Mutation };

// src/resolvers/Query.ts

// Defining Query methods
const Query = {
  // Query for users
  users(root: any, args: any, ctx: any) {
    // Code to query the user from the database
  }
};

export { Query };
```

Create the ```src``` directory and the index file inside ```src/index.ts``` with the following content.

```typescript
import { GraphQLServer } from "graphql-yoga";
import * as Sentry from "@sentry/node"
import dotenv from "dotenv";
import resolvers from "./resolvers";

// Config dotenv
dotenv.config();

// Setting up Sentry
Sentry.init({
  dsn: process.env.SENTRY_DSN
});

// Creating server options
const serverOptions = {
  context: (req: any) => ({
    loaders: {
      userLoader: // A user loarder.
      ...
    },
    ...
  }),
  resolvers,
  typeDefs: "./src/schema.graphql"
};

// Instatiating GraphQL-Yoga server
const server = new GraphQLServer(serverOptions);

// Starting the server with the cors enabled
server.start(
  {
    cors: {
      credentials: true,
      origin: process.env.FRONTEND_URL
    }
  },
  () =>
    console.log(
      `The server is listening on http://localhost:${process.env.PORT}`
    )
);

export { server };
```

We should be set to go and start the server, but before that we need to install more packages.

### Sentry

Installing a [Sentry](https://docs.sentry.io/) package, an open-source error tracking tool that helps you monitor and fix crashes in real time.

```
yarn add @sentry/node
```

### Dotenv

Installing a [Dotenv](https://www.npmjs.com/package/dotenv) package, a zero-dependency module that loads environment variables from a .env file into process.env.

```
yarn add dotenv @types/dotenv
```

### Nodemon

Installing a [nodemon](https://www.npmjs.com/package/nodemon) package, a tool that helps develop node.js based applications by automatically restarting the node application when file changes in the directory are detected.

### Jest

Installing [Jest](https://basarat.gitbooks.io/typescript/docs/testing/jest.html) package for testing the code.

```
yarn add jest @types/jest ts-jest
```

#### Config Jest

Add the following jest.config.js file to the root of your project

```javascript
module.exports = {
    "roots": [
        "<rootDir>"
    ],
    "transform": {
        "^.+\\.tsx?$": "ts-jest"
    },
    "testRegex": "(/__tests__/.*|(\\.|/)(test|spec))\\.tsx?$",
    "moduleFileExtensions": [
        "ts",
        "tsx",
        "js",
        "jsx",
        "json",
        "node"
    ],
}
```

### Husky

Install the [Husky](https://prettier.io/docs/en/precommit.html) package, used to make sure that committed files are formatted properly. 
**You must have created a git repository before installing Husky**.

```
git init # if not done already
yarn add husky lint-staged --dev
```

#### Config Husky

Add Husky and lint-staged related configuration details to the package.json file.

```json
{
  ...
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
 "lint-staged": {
    "src/**/*.{js,ts,tsx,json,css,graphql,md}": [
      "prettier --write",
      "git add"
    ]
  },
  ...
}
```

Then as a final step, for proper setting the project, we must include the ```.env``` file in the root directory, which will hold all the secrete values and must never be public.

```sh
touch .env
```

Then add the neccessary key value pairs content (At minimum, add the following, and you may add more as per the project setup).

```
Variable | Description | Example
---- | ---- | ----
FRONTEND_HOST | The host of the frontend accessing this server | https://ssda.saao.ac.za
TZ | The timezone, which must be UTC. | UTC
SESSION_SECRET | The secret key for for signing the session ID cookie | anothertopsecretkey
APP_SECRET | The secret key for this server | anothertopsecretkey
PORT | Port on which the server should be listening | 4000
SENTRY_DSN | The Sentry DSN (Data Source Name) | https://d6251ee8232d4au0b57cbhy38c059af6@sentry.io/237524
DATABASE_NAME | The ssda database name | ssda
DATABASE_HOST | The sdda database host | http://localhost
DATABASE_PORT | The sdda database port | 5432
DATABASE_PASSWORD | The ssda database host password | password
DATABASE_USER | The ssda host user name | username
```

We need to add the scripts commands to run the project. Edit the ```package.json``` file with the following content.

```json
"scripts": {
  "start": "pm2 start src/index.ts --name data-archive-api --node-args='-r dotenv/config'",
  "restart": "pm2 restart data-archive-api --node-args='-r dotenv/config'",
  "dev": " export DEBUG=\"nodemon\"; nodemon -e ts,graphql -x ts-node -r dotenv/config src/index.ts",
  "test": "NODE_ENV=test jest --detectOpenHandles",
  "test:coverage": "jest --coverage",
  "test:watch": "jest --watch",
  "format": "prettier --write '{*.json,src/**/*.{js,ts,tsx,json,graphql}}'",
  "lint": "tslint 'src/**/*.{ts,tsx}'",
  "lint:fix": "tslint --fix 'src/**/*.{ts,tsx}'"
},
```

Now, can run the following commands:

To start the server in the development mode

```
yarn dev
```

To start the server in the production mode

```
yarn start
```

To restart the server in the production mode

```
yarn restart
```

To test the server in the development mode

```
yarn test
```

To format the files with prettier and tslint.

```
yarn format
```

To check if tslint rules are fulfilled.

```
yarn lint
```

# The Fianl Project Structure

If followed as detailed above, the minimal project structure should look like (see below).

```
data-archive-backend
├── README.md
├── node_modules
├── package.json
├── tsconfig.json
├── tslint.json
├── jest.config.js
├── .env
├── .travis.yml
├── .prettierignore
├── .gitignore
├── docs
|   ├── project_setup.md
|   ├── server_setup.md
├── __tests__
│   ├── filename1.spec.ts
|   ├── filename2.spec.ts
└── src
    ├── index.ts
    ├── resolvers.ts
    ├── schema.graphql
    └── resolvers
        ├── index.ts
        ├── Mutations.ts
        ├── Query.ts
```